var getClosestVisit=function(visits,rangeEnd){if(visits.length===0)return 0;if(visits.length<20)for(let i=visits.length-1;i>=0;i-=1){let visit=visits[i];if(visit.visitTime<rangeEnd)return visit.visitTime}else{let lst=visits.length-1,fst=0,mid=0;while(fst<=lst){mid=Math.floor((fst+lst)/2);let visit=visits[mid];if(rangeEnd<visit.visitTime)lst=mid-1;else if(rangeEnd>visit.visitTime)fst=mid+1;else return-1}if(lst<0)return-1;else return visits[lst].visitTime}return-1},getFavicon=function(src){let url=chrome.runtime.getURL("/_favicon/");return url+="?pageUrl="+src+"&size=16",url},initStorage=function(items){let{open,focusTabs,theme}=items,set=!1;if(open===void 0)set=!0;else storage.open=open;if(focusTabs===void 0)set=!0;else storage.focusTabs=focusTabs,TabsProperties.active=focusTabs;if(theme===void 0)set=!0;else storage.theme=theme;if(set)chrome.storage.local.set(storage,void 0)},createDOMRangeSearch=function(startTime){const DOMRangeSearch=DOMTemplateRangeSearch.content.cloneNode(!0)?.firstElementChild;DOMRangeSearch?.setAttribute("data-starttime",String(startTime));const dateFormat=DateFormatter.format(startTime);return DOMRangeSearch?.firstElementChild?.firstElementChild?.insertAdjacentText("beforeend",dateFormat),DOMRangeSearch},createDOMRange=function(startTime){const DOMRange=DOMTemplateRange.content.cloneNode(!0)?.firstElementChild;DOMRange?.setAttribute("data-starttime",String(startTime));const dateFormat=DateFormatter.format(startTime);return DOMRange?.firstElementChild?.firstElementChild?.insertAdjacentText("beforeend",dateFormat),DOMRange?.firstElementChild?.lastElementChild?.setAttribute("title",`Remove ${dateFormat} browsing history`),DOMRange},createDOMItem=function(url,title,id,visitTime){const fragment=DOMTemplateItem.content.cloneNode(!0),DOMItem=fragment.firstElementChild;if(DOMItem?.setAttribute("href",url),DOMItem?.setAttribute("data-id",id),DOMItem?.children.img?.setAttribute("src",getFavicon(url)),title==="")DOMItem?.setAttribute("title",url),DOMItem?.children.title?.insertAdjacentText("beforeend",url);else DOMItem?.setAttribute("title",title+"\n"+url),DOMItem?.children.title?.insertAdjacentText("beforeend",title);return DOMItem?.children.time?.insertAdjacentText("beforeend",TimeFormatter.format(visitTime)),fragment};async function searchToDOM(historyItems){if(historyItems.length<1||historyItems.length===1&&historyItems[0].id===lastItemId){if(noMoreContent=!0,SearchQuery.maxResults=30,totalItems===0)DOMMainEmpty.removeAttribute("data-css-hidden");else if(DOMFragment.children.length>0){let DOMRange2=DOMMainContainer.lastElementChild;if(DOMRange2!==null)DOMRange2.appendChild(DOMFragment)}lastRangeIsFull=!1,DOMHeaderLoading.setAttribute("data-css-hidden","");return}let timeRangeEnd=0,timeRangeStart=0,i=0,DOMRange=null;if(TimeRange.length==0)if(timeRangeEnd=historyItems[0].lastVisitTime,timeRangeStart=TimeRange.createStart(timeRangeEnd),TimeRange.add(timeRangeEnd,timeRangeStart),searchMode)DOMRange=createDOMRangeSearch(timeRangeStart),DOMMainContainer.appendChild(DOMRange);else DOMRange=createDOMRange(timeRangeStart),DOMMainContainer.appendChild(DOMRange);else{if(timeRangeEnd=TimeRange.getLastEnd(),timeRangeStart=TimeRange.getLastStart(),historyItems[0].id===lastItemId)i=1;if(lastRangeIsFull)if(lastRangeIsFull=!1,searchMode)DOMRange=createDOMRangeSearch(timeRangeStart),DOMMainContainer.appendChild(DOMRange);else DOMRange=createDOMRange(timeRangeStart),DOMMainContainer.appendChild(DOMRange);else DOMRange=DOMMainContainer.lastElementChild;if(DOMRange===null)throw Error("#m_container.lastElementChild is null")}let lastVisitTime=0,item=historyItems[i],itemsCreated=0;while(i<historyItems.length){if(item=historyItems[i],item.lastVisitTime<timeRangeStart){lastVisitTime=item.lastVisitTime;break}if(item.visitCount!==void 0&&item.visitCount>1){if(visited.includes(item.id)){i+=1;continue}if(visited.push(item.id),timeRangeEnd<item.lastVisitTime){let visits;UrlDetails.url=item.url;try{visits=await chrome.history.getVisits(UrlDetails)}catch(e){console.error(e.message);continue}let visitTime=getClosestVisit(visits,timeRangeEnd);if(visitTime<0){i+=1;continue}if(lastVisitTime=visitTime,lastVisitTime<timeRangeStart)break}else lastVisitTime=item.lastVisitTime}else lastVisitTime=item.lastVisitTime;DOMFragment.appendChild(createDOMItem(item.url,item.title,item.id,lastVisitTime)),TimeRange.addElement(),itemsCreated+=1,i+=1}if(totalItems+=itemsCreated,itemsFromSearch+=itemsCreated,i<historyItems.length)lastRangeIsFull=!0,visited.length=0,SearchQuery.endTime=TimeRange.addFrom(lastVisitTime),lastItemId="";else SearchQuery.endTime=lastVisitTime,lastItemId=item.id;if(itemsFromSearch<20){if(30-itemsFromSearch<20)SearchQuery.maxResults=20;else SearchQuery.maxResults=30;return DOMRange.appendChild(DOMFragment),chrome.history.search(SearchQuery,searchToDOM)}else itemsFromSearch=0,SearchQuery.maxResults=30,DOMHeaderLoading.setAttribute("data-css-hidden",""),DOMRange.appendChild(DOMFragment),DOMMainContainer.onscroll=DOMMainContainerOnscroll}var initDOM=function(s){document.firstElementChild.setAttribute("class",s.theme),DOMFormConfig.theme.value=s.theme,DOMFormConfig.open_behavior.value=s.open,DOMFormConfig.focus.checked=s.focusTabs},openLink=function(tabsProperties,open,ctrl){if(open==="n"===ctrl)chrome.tabs.update(void 0,tabsProperties,void 0);else chrome.tabs.create(tabsProperties,void 0)},deleteLink=function(DOMItem,startTime){const url=DOMItem.getAttribute("href");UrlDetails.url=url;try{chrome.history.deleteUrl(UrlDetails,void 0)}catch(e){console.error(e.message)}const i=TimeRange.getStartIndex(startTime);if(i<0){console.error("ERROR: the start time does not founded");return}if(TimeRange.removeElement(i),TimeRange.elements[i]<1)DOMItem.parentElement.remove(),TimeRange.remove(i);else DOMItem.remove();totalItems-=1},searchAgain=function(){if(noMoreContent){if(totalItems<1)DOMMainEmpty.removeAttribute("data-css-hidden");return}if(DOMMainContainer.scrollTop>=DOMMainContainer.scrollHeight-DOMMainContainer.clientHeight-50)DOMHeaderLoading.setAttribute("data-css-hidden",""),chrome.history.search(SearchQuery,searchToDOM),DOMMainContainer.onscroll=null},DOMHeaderButtonsOnclick=function(e){let name=e.target.getAttribute("name");if(name==="history")TabsProperties.url="about://history",openLink(TabsProperties,storage.open,e.ctrlKey);else if(name==="clear"){let temp=TabsProperties.active;TabsProperties.url="about://settings/clearBrowserData",TabsProperties.active=!0,chrome.tabs.create(TabsProperties,void 0),TabsProperties.active=temp}else if(name==="more")DOMModal.removeAttribute("data-css-hidden");else if(name==="close")window.close()},DOMHeaderButtonsOnauxclick=function(e){if(e.target.getAttribute("name")==="history")TabsProperties.url="about://history",chrome.tabs.create(TabsProperties,void 0)},DOMFormSearchTimeout=function(){searchTimeout=void 0,DOMHeaderLoading.setAttribute("data-css-hidden",""),DOMMainContainer.replaceChildren(),SearchQuery.endTime=Date.now(),SearchQuery.text=DOMFormSearch.text.value,TimeRange.reset(),visited.length=0,totalItems=0,lastItemId="",noMoreContent=!1,lastRangeIsFull=!1,DOMMainEmpty.setAttribute("data-css-hidden",""),chrome.history.search(SearchQuery,searchToDOM),DOMMainContainer.onscroll=null},DOMFormSearchOninput=function(){if(DOMFormSearch.text.value.length!==0)searchMode=!0,DOMFormSearch.remove.removeAttribute("data-css-hidden");else searchMode=!1,DOMFormSearch.remove.setAttribute("data-css-hidden","");if(searchTimeout!==void 0)clearTimeout(searchTimeout);searchTimeout=setTimeout(DOMFormSearchTimeout,500),DOMHeaderLoading.removeAttribute("data-css-hidden")},DOMFormSearchOnclick=function(){DOMFormSearch.text.value="",DOMFormSearchOninput()},DOMMainContainerOnscroll=function(){if(noMoreContent)return;if(DOMMainContainer.scrollTop>=DOMMainContainer.scrollHeight-DOMMainContainer.clientHeight-50)DOMHeaderLoading.removeAttribute("data-css-hidden"),chrome.history.search(SearchQuery,searchToDOM),DOMMainContainer.onscroll=null},DOMMainContainerOnclick=function(e){const target=e.target;let type=target.getAttribute("data-type");if(type==="remove"){e.preventDefault();let datafor=target.getAttribute("data-for"),DOMParent=target?.parentElement,DOMRange=DOMParent?.parentElement,startTime=DOMRange?.getAttribute("data-starttime");if(startTime==null){console.error("ERROR: data-starttime attribute doesn't exist");return}if(datafor==="item")deleteLink(DOMParent,Number(startTime));else if(datafor==="date"){const i=TimeRange.getStartIndex(Number(startTime));if(i<0){console.error("ERROR: start time does not found");return}DeleteRange.startTime=TimeRange.starts[i],DeleteRange.endTime=TimeRange.ends[i];let elements=TimeRange.elements[i];chrome.history.deleteRange(DeleteRange),TimeRange.remove(i),totalItems-=elements,DOMRange.remove()}searchAgain()}else if(type==="item"){if(!e.shiftKey){e.preventDefault();const url=target.href;TabsProperties.url=url,openLink(TabsProperties,storage.open,e.ctrlKey)}}},DOMMainContainerOnauxclick=function(e){let target=e.target;if(target.getAttribute("data-type")==="item"){e.preventDefault();let href=target?.getAttribute("href");if(href===null||href===void 0){console.error('ERROR: [data-type="item"] does not have "href" attribute');return}TabsProperties.url=href,chrome.tabs.create(TabsProperties,void 0)}},DOMMainContainerOnkeydown=function(e){let target=e.target;if(target.getAttribute("data-type")!=="item")return;if(e.key==="q"){const startTime=target.parentElement?.getAttribute("data-starttime");if(startTime===null||startTime===void 0)console.error('ERROR: .range does not have "data-startitme" attribute');else deleteLink(target,Number(startTime)),searchAgain()}},DOMModalOnclick=function(e){let type=e.target.getAttribute("data-type");if(type==="modal"||type==="close")DOMModal?.setAttribute("data-css-hidden","")},DOMFormConfigOnchange=function(e){let target=e.target,name=target.getAttribute("name");if(name==="theme")if(target.value==="d"||target.value==="l")storage.theme=target.value,document.firstElementChild.setAttribute("class",target.value),storageChange=!0;else console.error("ERROR: the theme value is wrong");else if(name==="open_behavior")if(target.value==="n"||target.value==="c")storage.open=target.value,storageChange=!0;else console.error("ERROR: the open_behavior value is wrong");else if(name==="focus")storage.focusTabs=target.checked,TabsProperties.active=storage.focusTabs,storageChange=!0;if(storageChange)chrome.storage.local.set(storage,void 0)};var TIME_OFFSET=60000*(new Date()).getTimezoneOffset(),TimeFormatter=Intl.DateTimeFormat(void 0,{timeStyle:"short"}),DateFormatter=Intl.DateTimeFormat(void 0,{dateStyle:"full"}),TabsProperties={active:!1,url:""},UrlDetails={url:""},DeleteRange={endTime:0,startTime:0},SearchQuery={endTime:0,maxResults:30,startTime:0,text:""};var storage={focusTabs:!1,open:"c",theme:"d"},storageChange=!1,searchTimeout=void 0,searchMode=!1,totalItems=0,itemsFromSearch=0,noMoreContent=!1,visited=[],lastRangeIsFull=!1,lastItemId="",TimeRange={elements:[],ends:[],starts:[],length:0,createStart(ms){return ms-(ms-TIME_OFFSET)%86400000},addElement(){if(TimeRange.length>0){const elements=TimeRange.elements;return elements[TimeRange.length-1]+=1,!0}else return!1},removeElement(i){if(i<0||TimeRange.length<=i)return!1;if(TimeRange.elements[i]>0)return TimeRange.elements[i]-=1,!0;else return!1},getLastEnd(){if(TimeRange.length>0)return TimeRange.ends[TimeRange.length-1];return-1},getLastStart(){if(TimeRange.length>0)return TimeRange.starts[TimeRange.length-1]},getStartIndex(start){let{starts:startRange,length:lst}=TimeRange;if(lst<20)return startRange.indexOf(start);let fst=0,mid=0,el=0;while(fst<lst)if(mid=Math.floor((fst+lst)/2),el=startRange[mid],start===el)return mid;else if(el<start)lst=mid;else fst=mid+1;return-1},remove(i){var len=TimeRange.length;if(i<0||len<=i)return!1;return TimeRange.ends.copyWithin(i,i+1,len),TimeRange.ends.pop(),TimeRange.starts.copyWithin(i,i+1,len),TimeRange.starts.pop(),TimeRange.elements.copyWithin(i,i+1,len),TimeRange.elements.pop(),TimeRange.length-=1,!0},reset(){TimeRange.ends.length=0,TimeRange.starts.length=0,TimeRange.elements.length=0,TimeRange.length=0},add(end,start){return TimeRange.ends.push(end),TimeRange.starts.push(start),TimeRange.elements.push(0),TimeRange.length+=1,TimeRange.length-1},addFrom(ms){let start=TimeRange.createStart(ms);return TimeRange.add(start+86400000,start),start+86400000}},DOMFragment=document.createDocumentFragment(),DOMTemplateRangeSearch=document.getElementById("template_rangesearch");if(DOMTemplateRangeSearch===null)throw Error("ERROR: #template_rangesearch does not exist");var DOMTemplateRange=document.getElementById("template_range");if(DOMTemplateRange===null)throw Error("ERROR: #template_range does not exist");var DOMTemplateItem=document.getElementById("template_item");if(DOMTemplateItem===null)throw Error("ERROR: #template_item does not exist");var DOMHeaderLoading=document.getElementById("h_loading");if(DOMHeaderLoading===null)throw Error("ERROR: #h_loading does not exist");var DOMHeaderButtons=document.getElementById("h_buttons");if(DOMHeaderButtons===null)throw Error("ERROR: #h_buttons does not exist");var DOMFormSearch=document.forms.namedItem("search");if(DOMFormSearch===null)throw Error("ERROR: forms.search does not exist");var DOMMainEmpty=document.getElementById("m_empty");if(DOMMainEmpty===null)throw Error("ERROR: #m_empty does not exist");var DOMMainContainer=document.getElementById("m_container");if(DOMMainContainer===null)throw Error("ERROR: #m_container does not exist");var DOMModal=document.getElementById("modal");if(DOMModal===null)throw Error("ERROR: #modal does not exist");var DOMFormConfig=document.forms.namedItem("config");if(DOMFormConfig===null)throw Error("ERRORP: forms.config does not exist");chrome.storage.local.get(void 0,function(items){initStorage(items),initDOM(storage),SearchQuery.endTime=Date.now(),chrome.history.search(SearchQuery,searchToDOM)}),DOMHeaderButtons.addEventListener("click",DOMHeaderButtonsOnclick,!1),DOMHeaderButtons.addEventListener("auxclick",DOMHeaderButtonsOnauxclick,!1),DOMFormSearch.text.addEventListener("input",DOMFormSearchOninput,!1),DOMFormSearch.remove.addEventListener("click",DOMFormSearchOnclick,!1),DOMMainContainer.onscroll=DOMMainContainerOnscroll,DOMMainContainer.addEventListener("click",DOMMainContainerOnclick,!1),DOMMainContainer.addEventListener("auxclick",DOMMainContainerOnauxclick,!1),DOMMainContainer.addEventListener("keydown",DOMMainContainerOnkeydown,!1),DOMModal.addEventListener("click",DOMModalOnclick,!1),DOMFormConfig.addEventListener("change",DOMFormConfigOnchange,!1);
